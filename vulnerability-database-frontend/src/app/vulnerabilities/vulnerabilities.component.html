<!-- 
   The HTML code for the custom query page
   Author: Trey Cosnowski, Alex Bocchi
 -->

<mat-drawer-container class = "container" hasBackdrop = "false">
    
 
    <mat-drawer-content>
        
        <!-- query-interface.component.html -->
        <div class="warningDiv" [class.valid]="validForm && validDate && (queryForm.get('start_date') && queryForm.get('end_date'))" [class.invalid]="!validForm || !validDate || (!queryForm.get('start_date') || !queryForm.get('end_date'))">
            <h2 *ngIf="!validForm || !validDate || (!queryForm.get('start_date') || !queryForm.get('end_date')); else Validform" class="invalidForm">Invalid Query: Please Fix these Issues</h2>
            <ng-template #Validform><h2 class="validFormHeader">Valid Query</h2></ng-template>
            <ul class="warningList">
                <li *ngIf="!validBaseScore" class="warning">Both Base Score values must be filled and Min less than Max </li>
                <li *ngIf="!validExploitScore" class="warning">Both Exploitability Score values must be filled and Min less than Max</li>
                <li *ngIf="!validImpactScore" class="warning">Both Impact Score values must be filled in and Min less than Max</li>
                <li *ngIf="!queryForm.get('start_date') || !queryForm.get('end_date');" class="warning">Select a Start and End Date to Select Patch Levels</li>
                <li *ngIf="!validDate" class="warning">Start Date must be less than End Date</li>
            </ul>

        </div>
        <form [formGroup]="queryForm">

            <label for="bulletinType">Bulletin Type</label>
            <div class="checkbox-group">
                <input type="checkbox" id="Android OS" formControlName="androidOS" name="Android OS" value="Android OS" (change)="checkBulletin($event, 'Android OS')">
                <label for="Android OS">
                    Android OS
                </label>

                <input type="checkbox" id="Pixel" formControlName="pixel" name="Pixel" value="Pixel" (change)="checkBulletin($event, 'Pixel')">
                <label for="Pixel">
                    Pixel
                </label>
            </div>

            <div class="range-input">
                <label for="baseScore">Base Score Range:</label>
                <input type="number" id="baseScoreMin" formControlName="baseScoreMin"  name="baseScoreMin" placeholder="Min" (change)="checkValidation('baseScoreMin', 'baseScoreMax')" min="0" max="10">
                <input type="number" id="baseScoreMax" formControlName="baseScoreMax"  name="baseScoreMax" placeholder="Max" (change)="checkValidation('baseScoreMin', 'baseScoreMax')" min="0" max="10">
            </div>

            <div class="range-input">
                <label for="exploitabilityScore">Exploitability Score Range:</label>
                <input type="number" id="exploitabilityScoreMin" formControlName="exploitabilityScoreMin" name="exploitabilityScoreMin" placeholder="Min" (change)="checkValidation('exploitabilityScoreMin', 'exploitabilityScoreMax')" min="0" max="10">
                <input type="number" id="exploitabilityScoreMax" formControlName="exploitabilityScoreMax" name="exploitabilityScoreMax" placeholder="Max" (change)="checkValidation('exploitabilityScoreMin', 'exploitabilityScoreMax')" min="0" max="10">
            </div>

            <div class="range-input">
                <label for="impactScore">Impact Score Range:</label>
                <input type="number" id="impactScoreMin" formControlName="impactScoreMin" name="impactScoreMin" placeholder="Min" (change)="checkValidation('impactScoreMin', 'impactScoreMax')" min="0" max="10">
                <input type="number" id="impactScoreMax" formControlName="impactScoreMax" name="impactScoreMax" placeholder="Max" (change)="checkValidation('impactScoreMin', 'impactScoreMax')" min="0" max="10">
            </div>

            <div class="componentSearch">
                <label for="searchText">Component:</label>
                <input type="search" id="searchText" placeholder="Filter by component" formControlName='component' autofocus>
            </div>
            <ul class="componentSearchUl">
                <li class="component" *ngFor="let comp of components | componentFilter: queryForm.get('component')?.value" (click)="selectComponent(comp)">
                    {{comp}}
                </li>
            </ul>


            <!-- Date Fields are required -->
            <label for="dateFilterStart">Start Date</label>
            <input type="month" id="start_date" name="start_date" [min]="startDate"  [max]="queryForm.get('end_date')?.value" formControlName="start_date" (change)="checkDateValidation()">
                            
            <label for="dateFilterEnd">End Date</label>
            <input type="month" id="end_date" name="end_date" [min]="queryForm.get('start_date')?.value" [max]=endDate formControlName="end_date" (change)="checkDateValidation()">

            <label for="allDates">Entire Date Range</label>
            <input type="checkbox" id="allDates" name="allDates" checked (change)="selectAllDates($event)">

        
            <label for="patchLevel">Patch Levels:</label>
            <div *ngIf="queryForm.get('start_date') && queryForm.get('end_date')" class="checkbox-group">

                <input type="checkbox" id="patchLevel01" formControlName="patchLevel01" name="patchLevel01" (change)="onCheckBoxChange($event, 'patchLevel01')">
                <label for="patchLevel01">
                    {{queryForm.get('start_date')?.value}}-01 - {{queryForm.get('end_date')?.value}}-01
                </label>

                <input type="checkbox" id="patchLevel02" formControlName="patchLevel02" name="patchLevel02" (change)="onCheckBoxChange($event, 'patchLevel02')">
                <label for="patchLevel02">
                    {{queryForm.get('start_date')?.value}}-02 - {{queryForm.get('end_date')?.value}}-02
                </label>

                <input type="checkbox" id="patchLevel05" formControlName="patchLevel05" name="patchLevel05" (change)="onCheckBoxChange($event, 'patchLevel05')">
                <label for="patchLevel05">
                    {{queryForm.get('start_date')?.value}}-05 - {{queryForm.get('end_date')?.value}}-05
                </label>

                <input type="checkbox" id="patchLevel06" formControlName="patchLevel06" name="patchLevel06" (change)="onCheckBoxChange($event, 'patchLevel06')">
                <label for="patchLevel06">
                    {{queryForm.get('start_date')?.value}}-06 - {{queryForm.get('end_date')?.value}}-06
                </label>

            </div>
    

            <div class="dropdown-input">
                <label for="severity">Severity:</label>
                <select id="severity" formControlName="severity" name="severity">
                  <option value="Low">Low</option>
                  <option value="Moderate">Moderate</option>
                  <option value="High">High</option>
                  <option value="Critical">Critical</option>
                </select>
            </div>

            <div class="dropdown-input">
                <label for="order">Order:</label>
                <select id="order" formControlName="order" name="order">
                    <option value="date">Date Range</option>
                    <option value="base_score">Base Score</option>
                    <option value="exploitability_score">Exploitability Score</option>
                    <option value="impact_score">Impact Score</option>
                </select>
            </div>


            <div *ngIf="queryForm.get('order')?.value">
                <label for="dateOrder">Order Direction</label>
                <select id="orderDirection" formControlName="orderDirection" name="orderDirection">
                    <option value="ascending">Ascending</option>
                    <option value="descending">Descending</option>
                </select>
                
            </div>
            
            <button  type="submit" mat-raised-button (click)="onQueryChange()" [disabled]="!queryForm.valid || !validForm || !validDate">Search</button>
        </form>

        
    </mat-drawer-content>
</mat-drawer-container>



    


